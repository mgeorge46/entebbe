{% extends "includes/base.html" %}
{% load static %}
{% block greetings %}Flight Operations Whiteboard{% endblock greetings %}
{% block text %}Consolidated Calendar View{% endblock text %}
{% block breadlink1 %}{% url 'ops_dash' %}{% endblock breadlink1 %}{% block breadtext1 %}Operations{% endblock breadtext1 %}
{% block breadlink2 %}{% endblock breadlink2 %}{% block breadtext2 %}Whiteboard{% endblock breadtext2 %}
{% block breadlink3 %}{% endblock breadlink3 %}{% block breadtext3 %}Calendar{% endblock breadtext3 %}

{% block content %}
<style>
    .whiteboard-controls {
        background: #fff;
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .filter-section {
        margin-bottom: 15px;
    }
    
    .legend-item {
        display: inline-flex;
        align-items: center;
        margin-right: 20px;
        margin-bottom: 10px;
        cursor: pointer;
        padding: 8px 12px;
        border-radius: 6px;
        transition: background 0.2s;
    }
    
    .legend-item:hover {
        background: #f8f9fa;
    }
    
    .legend-item input[type="checkbox"] {
        margin-right: 8px;
        width: 18px;
        height: 18px;
        cursor: pointer;
    }
    
    .legend-color {
        width: 20px;
        height: 20px;
        border-radius: 4px;
        margin-right: 8px;
        display: inline-block;
    }
    
    .legend-text {
        font-size: 14px;
        font-weight: 500;
        color: #39475B;
    }
    
    #calendar {
        background: #fff;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        min-height: 600px;
    }
    
    /* FullCalendar styling fixes */
    .fc {
        max-width: 100%;
    }
    
    .fc-toolbar-title {
        font-size: 1.5em !important;
        color: #3B7CFF;
        font-weight: 600;
    }
    
    .fc-button {
        background-color: #3B7CFF !important;
        border-color: #3B7CFF !important;
        color: white !important;
        text-transform: capitalize !important;
        padding: 6px 12px !important;
    }
    
    .fc-button:hover {
        background-color: #2868d9 !important;
        border-color: #2868d9 !important;
    }
    
    .fc-button-active {
        background-color: #1d4ed8 !important;
        border-color: #1d4ed8 !important;
    }
    
    .fc-event {
        cursor: pointer;
        border-radius: 3px;
        padding: 2px 4px;
        font-size: 11px;
        font-weight: 600;
        border-left: 3px solid rgba(0,0,0,0.3);
    }
    
    .fc-event:hover {
        opacity: 0.9;
        transform: translateY(-1px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    
    .fc-daygrid-event {
        white-space: normal !important;
    }
    
    .fc-event-title {
        font-weight: 600;
    }
    
    /* View mode buttons */
    .view-mode-buttons {
        display: flex;
        gap: 5px;
    }
    
    .view-btn {
        padding: 8px 16px;
        border: 1px solid #3B7CFF;
        background: white;
        color: #3B7CFF;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.2s;
    }
    
    .view-btn:hover {
        background: #f0f5ff;
    }
    
    .view-btn.active {
        background: #3B7CFF;
        color: white;
    }
    
    /* Quick action buttons */
    .quick-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .quick-action-btn {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        color: white;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .quick-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .btn-schedule-flight {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }
    
    .btn-schedule-crew {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }
    
    .btn-schedule-maintenance {
        background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }
    
    /* Modal styling */
    .modal-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }
    
    .detail-row {
        padding: 10px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
    }
    
    .detail-row:last-child {
        border-bottom: none;
    }
    
    .detail-label {
        font-weight: 600;
        color: #495057;
        min-width: 180px;
    }
    
    .detail-value {
        color: #212529;
        flex: 1;
    }
    
    .crew-list {
        list-style: none;
        padding: 0;
        margin: 0;
    }
    
    .crew-list li {
        padding: 5px 0;
    }
</style>

<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css' rel='stylesheet' />

<!-- Controls Panel -->
<div class="whiteboard-controls">
    <div class="row">
        <div class="col-md-12">
            <h5 class="mb-3">üìä Display Options</h5>
            
            <!-- Filter Checkboxes -->
            <div class="filter-section">
                <label class="legend-item">
                    <input type="checkbox" id="showFlights" checked>
                    <span class="legend-color" style="background: #007bff;"></span>
                    <span class="legend-text">‚úàÔ∏è Flights</span>
                </label>
                
                <label class="legend-item">
                    <input type="checkbox" id="showCrew" checked>
                    <span class="legend-color" style="background: #28a745;"></span>
                    <span class="legend-text">üë• Crew Schedules</span>
                </label>
                
                <label class="legend-item">
                    <input type="checkbox" id="showMaintenanceDue" checked>
                    <span class="legend-color" style="background: #dc3545;"></span>
                    <span class="legend-text">üî¥ Maintenance Due</span>
                </label>
                
                <label class="legend-item">
                    <input type="checkbox" id="showMaintenanceRecommended" checked>
                    <span class="legend-color" style="background: #fd7e14;"></span>
                    <span class="legend-text">üü† Recommended</span>
                </label>
                
                <label class="legend-item">
                    <input type="checkbox" id="showMaintenanceScheduled" checked>
                    <span class="legend-color" style="background: #6f42c1;"></span>
                    <span class="legend-text">üü£ Scheduled Maint.</span>
                </label>
            </div>
            
            <!-- Filters Row -->
            <div class="row mt-3">
                <div class="col-md-3">
                    <label>Filter by Aircraft:</label>
                    <select class="form-control" id="aircraftFilter">
                        <option value="">All Aircraft</option>
                        {% for aircraft in aircrafts %}
                        <option value="{{ aircraft.id }}">{{ aircraft.abbreviation }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label>Filter by Status:</label>
                    <select class="form-control" id="statusFilter">
                        <option value="">All Statuses</option>
                        <option value="Scheduled">Scheduled</option>
                        <option value="OnTrip">On Trip</option>
                        <option value="Completed">Completed</option>
                        <option value="Cancelled">Cancelled</option>
                    </select>
                </div>
                
                <div class="col-md-3">
                    <label>View Mode:</label>
                    <div class="view-mode-buttons">
                        <button class="view-btn" onclick="changeView('dayGridMonth')">Month</button>
                        <button class="view-btn active" onclick="changeView('timeGridWeek')">Week</button>
                        <button class="view-btn" onclick="changeView('timeGridDay')">Day</button>
                        <button class="view-btn" onclick="changeView('listWeek')">List</button>
                    </div>
                </div>
                
                <div class="col-md-3">
                    <label>Quick Actions:</label>
                    <div class="quick-actions">
                        <button class="quick-action-btn btn-schedule-flight" onclick="window.location.href='{% url 'flight_create' %}'">
                            <i class="fa fa-plane"></i>
                            <span>Schedule Flight</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Calendar Container -->
<div id="calendar"></div>

<!-- Event Detail Modal -->
<div class="modal fade" id="eventDetailModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="eventDetailTitle">Event Details</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body" id="eventDetailBody">
                <!-- Content loaded dynamically -->
            </div>
            <div class="modal-footer">
                <div id="eventActions"></div>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Flight Modal -->
<div class="modal fade" id="scheduleFlightModal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule New Flight</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Click on a date/time in the calendar to schedule a flight, or use the button below:</p>
                <a href="{% url 'flight_create' %}" class="btn btn-primary btn-lg btn-block" target="_blank">
                    <i class="fa fa-plane"></i> Go to Flight Scheduling Form
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Schedule Maintenance Modal -->
<div class="modal fade" id="scheduleMaintenanceModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Schedule Maintenance</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <input type="hidden" id="maint_component_type">
                    <input type="hidden" id="maint_component_id">
                    
                    <div class="form-group">
                        <label>Component: <span id="maint_component_name"></span></label>
                    </div>
                    
                    <div class="form-group">
                        <label>Maintenance Type:</label>
                        <select class="form-control" id="maint_type" required>
                            <option value="">Select Type</option>
                            <option value="Class_A">Class A Check</option>
                            <option value="Class_B">Class B Check</option>
                            <option value="Class_C">Class C Check</option>
                            <option value="Class_D">Class D Check</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Start Date:</label>
                        <input type="datetime-local" class="form-control" id="maint_start" required>
                    </div>
                    
                    <div class="form-group">
                        <label>End Date:</label>
                        <input type="datetime-local" class="form-control" id="maint_end" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Remarks:</label>
                        <textarea class="form-control" id="maint_remarks" rows="3"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="submitMaintenance()">
                    <i class="fa fa-save"></i> Schedule Maintenance
                </button>
            </div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
<script>
let calendar;

document.addEventListener('DOMContentLoaded', function() {
    console.log('Initializing whiteboard calendar...');
    
    const calendarEl = document.getElementById('calendar');
    
    if (!calendarEl) {
        console.error('Calendar element not found!');
        return;
    }
    
    // Initialize FullCalendar
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        height: 'auto',
        navLinks: true,
        editable: false,
        selectable: true,
        selectMirror: true,
        dayMaxEvents: true,
        nowIndicator: true,
        
        // Event source - fetch from Django backend
        events: function(info, successCallback, failureCallback) {
            console.log('Fetching events from', info.startStr, 'to', info.endStr);
            
            const params = new URLSearchParams({
                start: info.startStr,
                end: info.endStr,
                show_flights: document.getElementById('showFlights').checked,
                show_crew: document.getElementById('showCrew').checked,
                show_maintenance_due: document.getElementById('showMaintenanceDue').checked,
                show_maintenance_recommended: document.getElementById('showMaintenanceRecommended').checked,
                show_maintenance_scheduled: document.getElementById('showMaintenanceScheduled').checked,
                aircraft: document.getElementById('aircraftFilter').value,
                status: document.getElementById('statusFilter').value,
            });
            
            fetch(`/operations/whiteboard/data/?${params}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received', data.length, 'events');
                    successCallback(data);
                })
                .catch(error => {
                    console.error('Error fetching events:', error);
                    alert('Error loading calendar data. Check console for details.');
                    failureCallback(error);
                });
        },
        
        // When event is clicked
        eventClick: function(info) {
            console.log('Event clicked:', info.event.extendedProps);
            showEventDetails(info.event);
        },
        
        // When empty date/time is clicked
        dateClick: function(info) {
            console.log('Date clicked:', info.dateStr);
            if (confirm(`Schedule a new flight for ${info.dateStr}?\n\nClick OK to open flight scheduling form.`)) {
                window.open('{% url "flight_create" %}?date=' + info.dateStr, '_blank');
            }
        },
        
        // When date range is selected
        select: function(info) {
            console.log('Date range selected:', info.startStr, 'to', info.endStr);
            if (confirm(`Schedule maintenance from ${info.startStr} to ${info.endStr}?`)) {
                // Open maintenance scheduling
                alert('Maintenance scheduling will open here. Select a component first.');
            }
            calendar.unselect();
        },
        
        // Loading indicator
        loading: function(isLoading) {
            if (isLoading) {
                console.log('Loading events...');
            } else {
                console.log('Events loaded');
            }
        },
        
        // Event rendering
        eventDidMount: function(info) {
            // Add hover tooltip
            const props = info.event.extendedProps;
            let tooltip = info.event.title;
            
            if (props.type === 'flight') {
                tooltip += `\n${props.origin} ‚Üí ${props.destination}`;
            }
            
            info.el.title = tooltip;
        }
    });
    
    // Render the calendar
    calendar.render();
    console.log('Calendar rendered successfully');
    
    // Filter change handlers
    document.querySelectorAll('.legend-item input[type="checkbox"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            console.log('Filter changed:', this.id, this.checked);
            calendar.refetchEvents();
        });
    });
    
    document.getElementById('aircraftFilter').addEventListener('change', function() {
        console.log('Aircraft filter changed:', this.value);
        calendar.refetchEvents();
    });
    
    document.getElementById('statusFilter').addEventListener('change', function() {
        console.log('Status filter changed:', this.value);
        calendar.refetchEvents();
    });
});

// Change view function
function changeView(viewName) {
    console.log('Changing view to:', viewName);
    calendar.changeView(viewName);
    
    // Update active button
    document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
}

// Show event details
function showEventDetails(event) {
    const props = event.extendedProps;
    let html = '';
    let actions = '';
    let title = event.title;
    
    console.log('Showing details for:', props.type);
    
    if (props.type === 'flight' || props.type === 'flight_return') {
        title = `‚úàÔ∏è Flight ${props.flight_number}`;
        html = `
            <div class="detail-row">
                <span class="detail-label">Flight Number:</span>
                <span class="detail-value"><strong>${props.flight_number}</strong></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Route:</span>
                <span class="detail-value">${props.origin} ‚Üí ${props.destination}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Aircraft:</span>
                <span class="detail-value">${props.aircraft}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value"><span class="badge badge-primary">${props.status}</span></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Departure:</span>
                <span class="detail-value">${event.start.toLocaleString()}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Arrival:</span>
                <span class="detail-value">${event.end ? event.end.toLocaleString() : 'N/A'}</span>
            </div>
        `;
        
        if (props.cabin_crew) {
            html += `
                <div class="detail-row">
                    <span class="detail-label">Cabin Crew:</span>
                    <span class="detail-value">${props.cabin_crew || 'Not assigned'}</span>
                </div>
            `;
        }
        
        if (props.flight_crew) {
            html += `
                <div class="detail-row">
                    <span class="detail-label">Flight Crew:</span>
                    <span class="detail-value">${props.flight_crew || 'Not assigned'}</span>
                </div>
            `;
        }
        
        actions = `
            <a href="/dispatch/schedule/update/${props.flight_id}" class="btn btn-warning" target="_blank">
                <i class="fa fa-edit"></i> Edit Flight
            </a>
            <a href="/dispatch/schedule/details/${props.flight_number}/" class="btn btn-info" target="_blank">
                <i class="fa fa-info-circle"></i> View Details
            </a>
        `;
    } 
    else if (props.type === 'crew_schedule') {
        title = `üë§ Crew: ${props.crew_name}`;
        html = `
            <div class="detail-row">
                <span class="detail-label">Crew Member:</span>
                <span class="detail-value"><strong>${props.crew_name}</strong></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Role:</span>
                <span class="detail-value">${props.crew_type}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Flight:</span>
                <span class="detail-value">${props.flight_number}</span>
            </div>
        `;
        
        actions = `
            <a href="/accounts/details/${props.crew_id}/" class="btn btn-info" target="_blank">
                <i class="fa fa-user"></i> View Profile
            </a>
            <a href="/dispatch/schedule/details/${props.flight_number}/" class="btn btn-primary" target="_blank">
                <i class="fa fa-plane"></i> View Flight
            </a>
        `;
    }
    else if (props.type === 'maintenance_due' || props.type === 'maintenance_recommended') {
        const isDue = props.type === 'maintenance_due';
        title = `${isDue ? 'üî¥' : 'üü†'} ${props.component_name}`;
        
        html = `
            <div class="detail-row">
                <span class="detail-label">Component:</span>
                <span class="detail-value"><strong>${props.component_name}</strong></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Aircraft:</span>
                <span class="detail-value">${props.aircraft}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Serial Number:</span>
                <span class="detail-value">${props.serial_number}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Maintenance Hours:</span>
                <span class="detail-value"><strong>${props.maintenance_hours}</strong> hours remaining</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">${isDue ? 'Due Date' : 'Recommended Date'}:</span>
                <span class="detail-value"><strong class="${isDue ? 'text-danger' : 'text-warning'}">${isDue ? props.due_date : props.recommended_date}</strong></span>
            </div>
        `;
        
        actions = `
            <button class="btn btn-warning" onclick="openScheduleMaintenance('${props.component_type}', ${props.component_id}, '${props.component_name}')">
                <i class="fa fa-wrench"></i> Schedule Maintenance
            </button>
        `;
    }
    else if (props.type === 'maintenance_scheduled') {
        title = `üõ†Ô∏è Scheduled: ${props.component_name}`;
        html = `
            <div class="detail-row">
                <span class="detail-label">Component:</span>
                <span class="detail-value"><strong>${props.component_name}</strong></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Aircraft:</span>
                <span class="detail-value">${props.aircraft}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Maintenance Type:</span>
                <span class="detail-value"><span class="badge badge-purple">${props.maintenance_type}</span></span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Status:</span>
                <span class="detail-value">${props.status}</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Remarks:</span>
                <span class="detail-value">${props.remarks || 'N/A'}</span>
            </div>
        `;
    }
    
    document.getElementById('eventDetailTitle').innerHTML = title;
    document.getElementById('eventDetailBody').innerHTML = html;
    document.getElementById('eventActions').innerHTML = actions;
    $('#eventDetailModal').modal('show');
}

// Open schedule maintenance modal
function openScheduleMaintenance(componentType, componentId, componentName) {
    document.getElementById('maint_component_type').value = componentType;
    document.getElementById('maint_component_id').value = componentId;
    document.getElementById('maint_component_name').textContent = componentName;
    
    // Set default dates (tomorrow to 3 days from now)
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const endDate = new Date(tomorrow);
    endDate.setDate(endDate.getDate() + 3);
    
    document.getElementById('maint_start').value = tomorrow.toISOString().slice(0, 16);
    document.getElementById('maint_end').value = endDate.toISOString().slice(0, 16);
    
    $('#eventDetailModal').modal('hide');
    $('#scheduleMaintenanceModal').modal('show');
}

// Submit maintenance schedule
function submitMaintenance() {
    const formData = new FormData();
    formData.append('component_type', document.getElementById('maint_component_type').value);
    formData.append('component_id', document.getElementById('maint_component_id').value);
    formData.append('start_date', document.getElementById('maint_start').value);
    formData.append('end_date', document.getElementById('maint_end').value);
    formData.append('maintenance_type', document.getElementById('maint_type').value);
    formData.append('remarks', document.getElementById('maint_remarks').value);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
    
    fetch('/operations/whiteboard/schedule-maintenance/', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Maintenance scheduled successfully!');
            $('#scheduleMaintenanceModal').modal('hide');
            calendar.refetchEvents();
        } else {
            alert('‚ùå Error: ' + (data.error || 'Failed to schedule maintenance'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('‚ùå Failed to schedule maintenance. Check console for details.');
    });
}

// Auto-refresh every 5 minutes
setInterval(function() {
    console.log('Auto-refreshing calendar...');
    calendar.refetchEvents();
}, 300000);

console.log('Whiteboard calendar fully initialized');
</script>

{% endblock content %}