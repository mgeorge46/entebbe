{% extends "includes/base.html" %}
{% block greetings %}Complete Batch Maintenance{% endblock greetings %}
{% block content %}

<style>
    .batch-header {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: white;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .component-card {
        border: 1px solid #dee2e6;
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 5px;
        background: white;
    }
</style>

<div class="batch-header">
    <h3><i class="fa fa-check-double"></i> Complete Batch Maintenance</h3>
    <p class="mb-0">
        Batch ID: <strong>{{ batch_id }}</strong> &nbsp;|&nbsp;
        {{ total_records }} component(s) in this batch
    </p>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="fa fa-list"></i> Components in This Batch</h6>
            </div>
            <div class="card-body">
                {% for record in maintenance_records %}
                <div class="component-card">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <strong>{{ record.component_to_maintain.component_name }}</strong><br>
                            <small class="text-muted">
                                SN: {{ record.component_to_maintain.serial_number }} | 
                                Current: {{ record.component_to_maintain.maintenance_hours }} hrs
                            </small>
                        </div>
                        <div class="col-md-6 text-right">
                            <span class="badge badge-info">{{ record.get_maintenance_type_display }}</span>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Completion Form -->
        <div class="card mt-3">
            <div class="card-header bg-success text-white">
                <h6 class="mb-0"><i class="fa fa-clipboard-check"></i> Sign Off All Components</h6>
            </div>
            <div class="card-body">
                <form method="POST" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="alert alert-info">
                        <i class="fa fa-info-circle"></i>
                        The same completion details will be applied to <strong>ALL {{ total_records }} components</strong> in this batch.
                    </div>
                    
                    <div class="form-group">
                        <label>Actual Completion Date <span class="text-danger">*</span></label>
                        <input type="datetime-local" name="actual_end_date" class="form-control" required>
                        <small class="text-muted">When was the batch maintenance completed?</small>
                    </div>
                    
                    <div class="form-group">
                        <label>Hours to Add to Each Component <span class="text-danger">*</span></label>
                        <input type="number" name="hours_added" class="form-control" 
                               step="0.01" min="0" value="0" required id="hours_input">
                        <small class="text-muted">
                            <i class="fa fa-calculator"></i> This amount will be added to EACH component
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label>Completion Remarks <span class="text-danger">*</span></label>
                        <textarea name="completion_remarks" class="form-control" rows="5" 
                                  placeholder="Describe work performed across all components..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>Upload Batch Completion Report</label>
                        <input type="file" name="completion_report" class="form-control-file" 
                               accept=".pdf,.doc,.docx,.xlsx,.xls">
                        <small class="text-muted">
                            <i class="fa fa-paperclip"></i> Single report for entire batch
                        </small>
                    </div>
                    
                    <div class="alert alert-warning">
                        <i class="fa fa-exclamation-triangle"></i>
                        <strong>Confirmation Required:</strong><br>
                        • All {{ total_records }} components will be marked as "Completed"<br>
                        • Each component will receive <strong><span id="hours_display">0</span> hours</strong><br>
                        • This action cannot be easily undone
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg btn-block">
                        <i class="fa fa-check-double"></i> Sign Off All {{ total_records }} Components
                    </button>
                    <a href="{% url 'batch_maintenance_view' batch_id %}" class="btn btn-secondary btn-lg btn-block">
                        Cancel
                    </a>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar - Impact Preview -->
    <div class="col-lg-4">
        <div class="card sticky-top" style="top: 20px;">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0"><i class="fa fa-calculator"></i> Impact Summary</h6>
            </div>
            <div class="card-body">
                <p>
                    <strong>Components Affected:</strong><br>
                    <span class="h3">{{ total_records }}</span>
                </p>
                <p>
                    <strong>Hours Per Component:</strong><br>
                    <span class="h3 text-success" id="hours_per_comp">0</span> hrs
                </p>
                <hr>
                <p>
                    <strong>Total Hours Added:</strong><br>
                    <span class="h2 text-primary" id="total_hours">0</span> hrs
                </p>
                
                <div class="alert alert-info mt-3">
                    <small>
                        <i class="fa fa-lightbulb-o"></i>
                        Each component will have its maintenance hours increased by the amount you specify.
                    </small>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const hoursInput = document.getElementById('hours_input');
    const componentCount = {{ total_records }};
    
    hoursInput.addEventListener('input', function() {
        const hoursPerComp = parseFloat(this.value) || 0;
        const totalHours = hoursPerComp * componentCount;
        
        document.getElementById('hours_display').textContent = hoursPerComp.toFixed(2);
        document.getElementById('hours_per_comp').textContent = hoursPerComp.toFixed(2);
        document.getElementById('total_hours').textContent = totalHours.toFixed(2);
    });
});
</script>

{% endblock content %}